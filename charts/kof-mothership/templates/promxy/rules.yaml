apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "promxy.fullname" . }}-promxy-rules
  namespace: {{ $.Release.Namespace }}
data:
  kubernetes-resources.yaml: |
    groups:
      - name: kubernetes-resources
        rules:
          - alert: CPUThrottlingHigh
            annotations:
              description: '{{`{{`}} $value | humanizePercentage {{`}}`}} throttling of CPU in namespace {{`{{`}} $labels.namespace {{`}}`}} for container {{`{{`}} $labels.container {{`}}`}} in pod {{`{{`}} $labels.pod {{`}}`}}.'
              runbook_url: 'https://runbooks.prometheus-operator.dev/runbooks/kubernetes/cputhrottlinghigh'
              summary: 'Processes experience elevated CPU throttling.'
            expr: |-
              sum(increase(container_cpu_cfs_throttled_periods_total{container!="", }[5m])) by (container,pod,namespace,{{ $.Values.global.clusterLabel }})
                /
              sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container,pod,namespace,{{ $.Values.global.clusterLabel }})
                > ( 25 / 100 )
            for: 15m
            labels:
              severity: info
